"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runScript = void 0;
/**
 * Use it in your top-level scripts like this:
 *
 * runScript(async () => {
 *   await lalala()
 *   // my script goes on....
 * })
 *
 * Advantages:
 * - Works kind of like top-level await
 * - No need to add `void`
 * - No need to add `.then(() => process.exit()` (e.g to close DB connections)
 * - No need to add `.catch(err => { console.error(err); process.exit(1) })`
 *
 * This function is kept light, dependency-free, exported separately.
 */
function runScript(fn, opt = {}) {
    const { logger = console, noExit } = opt;
    process.on('uncaughtException', err => {
        logger.error('uncaughtException:', err);
    });
    process.on('unhandledRejection', err => {
        logger.error('unhandledRejection:', err);
    });
    void (async () => {
        try {
            await fn();
            if (!noExit) {
                setImmediate(() => process.exit(0));
            }
        }
        catch (err) {
            logger.error('runScript error:', err);
            process.exitCode = 1;
            if (!noExit) {
                setImmediate(() => process.exit(1));
            }
        }
    })();
}
exports.runScript = runScript;
